name: Repo Sync

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_PAT }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for upstream updates
        id: check-updates
        run: |
          # This is a placeholder for actual sync logic
          # In a real scenario, you would:
          # 1. Add upstream remote if syncing from a template/parent repo
          # 2. Fetch upstream changes
          # 3. Merge or create PR with updates
          
          echo "Checking for repository updates..."
          
          # Example: Check if there's an upstream repository configured
          UPSTREAM_URL="${{ secrets.UPSTREAM_REPO_URL }}"
          
          if [ -z "$UPSTREAM_URL" ]; then
            echo "No upstream repository configured. Skipping sync."
            echo "has_updates=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Add upstream remote
          git remote add upstream "$UPSTREAM_URL" 2>/dev/null || true
          git fetch upstream
          
          # Check for new commits
          COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/main 2>/dev/null || echo "0")
          
          if [ "$COMMITS_BEHIND" -gt "0" ]; then
            echo "Repository is $COMMITS_BEHIND commits behind upstream"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "Repository is up to date"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Create sync PR
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_PAT }}
          script: |
            const { execSync } = require('child_process');
            
            // Create a new branch for sync
            const syncBranch = `automated-sync-${Date.now()}`;
            execSync(`git checkout -b ${syncBranch}`);
            
            // Attempt to merge upstream changes
            try {
              execSync('git merge upstream/main --no-edit');
            } catch (error) {
              console.log('Merge conflicts detected. Creating PR for manual resolution.');
              execSync('git merge --abort', { stdio: 'ignore' });
              try {
                execSync('git merge --no-commit --no-ff upstream/main');
              } catch (e) {
                // Continue even if merge fails
              }
            }
            
            // Push the sync branch
            execSync(`git push origin ${syncBranch}`);
            
            // Create PR using GitHub API
            await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'chore: sync with upstream repository',
              body: `This PR syncs changes from the upstream repository.
            
            **Changes:** Automated sync from upstream
            **Action Required:** Review and resolve any conflicts if present
            
            This is an automated PR created by the repo-sync workflow.`,
              base: 'main',
              head: syncBranch
            });

      - name: Report sync status
        if: always()
        run: |
          echo "=== Repo Sync Status ==="
          echo "Has Updates: ${{ steps.check-updates.outputs.has_updates }}"
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "======================="

      - name: Create sync summary issue
        if: steps.check-updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_PAT }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“‹ Repository Sync Report - ' + new Date().toISOString().split('T')[0],
              body: `## Repository Sync Summary
              
              A sync with the upstream repository has been initiated.
              
              **Status:** Updates available
              **Action:** A pull request has been created for review
              
              Please review and merge the sync PR to keep the repository up to date.`,
              labels: ['automated', 'repo-sync']
            });
